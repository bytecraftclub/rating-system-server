<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>File Upload Test</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Roboto,
          'Segoe UI',
          Arial;
        padding: 20px;
        background: #0f1724;
        color: #e6eef8;
      }
      .card {
        background: #0b1220;
        padding: 20px;
        border-radius: 8px;
        max-width: 720px;
        margin: 0 auto;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
      }
      label {
        display: block;
        margin-top: 12px;
        font-weight: 600;
      }
      input[type='text'],
      input[type='file'] {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        border-radius: 6px;
        border: 1px solid #263149;
        background: #0b1226;
        color: #e6eef8;
      }
      button {
        margin-top: 16px;
        padding: 10px 14px;
        border-radius: 8px;
        background: #0969da;
        color: white;
        border: 0;
        cursor: pointer;
      }
      pre {
        background: #071025;
        padding: 12px;
        border-radius: 6px;
        overflow: auto;
        margin-top: 12px;
        color: #cfe8ff;
      }
      .hint {
        font-size: 13px;
        color: #9fb0d6;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Upload Test</h2>
      <p class="hint">
        Sends multipart/form-data to
        <strong>http://localhost:3009/files/upload</strong>.
      </p>

      <form id="uploadForm">
        <label for="file">File (field name must be <code>file</code>)</label>
        <input id="file" name="file" type="file" required />

        <label for="taskTitle">taskTitle</label>
        <input
          id="taskTitle"
          name="taskTitle"
          type="text"
          value="Build Authentication Module"
          required
        />

        <label for="userId">userId</label>
        <input
          id="userId"
          name="userId"
          type="text"
          value="27cbf21fbecb"
          required
        />

        <!-- Hidden fields filled automatically but can be overridden -->
        <input id="originalName" name="originalName" type="hidden" />
        <input id="mimeType" name="mimeType" type="hidden" />
        <input id="fileSize" name="fileSize" type="hidden" />

        <button type="submit">Upload</button>
      </form>

      <pre id="result">Server response will appear here...</pre>
      <p class="hint">
        If you get CORS errors, enable CORS in your NestJS backend or serve this
        file from <code>http://localhost</code>.
      </p>
    </div>

    <script>
      const fileInput = document.getElementById('file');
      const originalNameInput = document.getElementById('originalName');
      const mimeTypeInput = document.getElementById('mimeType');
      const fileSizeInput = document.getElementById('fileSize');
      const form = document.getElementById('uploadForm');
      const result = document.getElementById('result');

      // When user selects a file, auto-fill originalName, mimeType, fileSize
      fileInput.addEventListener('change', () => {
        const f = fileInput.files[0];
        if (!f) return;
        originalNameInput.value = f.name;
        mimeTypeInput.value = f.type || 'application/octet-stream';
        fileSizeInput.value = String(f.size); // will be sent as string; backend ValidationPipe(transform:true) converts it
      });

      // Submit with fetch using FormData (multipart/form-data)
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        result.textContent = 'Uploading...';

        // If file wasn't touched, we still want to ensure hidden fields reflect it
        if (fileInput.files[0]) {
          const f = fileInput.files[0];
          originalNameInput.value = originalNameInput.value || f.name;
          mimeTypeInput.value =
            mimeTypeInput.value || f.type || 'application/octet-stream';
          fileSizeInput.value = fileSizeInput.value || String(f.size);
        }

        const fd = new FormData(form); // includes file + text + hidden fields

        try {
          const res = await fetch('http://localhost:3009/files/upload', {
            method: 'POST',
            body: fd,
            // Don't set Content-Type header (browser will set it including boundary)
          });

          const text = await res.text(); // server might return JSON or text
          // try to parse JSON for nicer output
          try {
            const json = JSON.parse(text);
            result.textContent = JSON.stringify(json, null, 2);
          } catch {
            result.textContent = `Status: ${res.status}\n\n${text}`;
          }
        } catch (err) {
          result.textContent = 'Network error or CORS issue:\n' + err;
        }
      });
    </script>
  </body>
</html>
