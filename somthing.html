<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Files Gallery</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f9f9f9;
        padding: 20px;
      }
      .file-card {
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        width: 260px;
        display: inline-block;
        vertical-align: top;
        text-align: center;
      }
      .file-card img {
        width: 200px;
        border-radius: 5px;
        margin-bottom: 10px;
      }
      .file-card button {
        margin: 5px;
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        color: white;
      }
      .accept-btn {
        background-color: #4caf50;
      }
      .refuse-btn {
        background-color: #f44336;
      }
    </style>
  </head>
  <body>
    <h1>Uploaded Files</h1>
    <div id="gallery"></div>

    <script>
      async function fetchFiles() {
        const res = await fetch('http://localhost:3009/files/allFiles');
        console.log('Fetched file data response:', res);
        const files = await res.json();
        console.log('Fetched files:', files);

        const gallery = document.getElementById('gallery');
        gallery.innerHTML = '';

        files.forEach(async (file) => {
          const card = document.createElement('div');
          card.className = 'file-card';

          // Fetch file data blob
          const fileRes = await fetch(
            `http://localhost:3009/files/${file.id}/data`,
          );

          const blob = await fileRes.blob();
          const url = URL.createObjectURL(blob);

          // Show image if image, otherwise link
          let content;
          if (file.mimeType.startsWith('image/')) {
            content = document.createElement('img');
            content.src = url;
            content.alt = file.originalName;
          } else {
            content = document.createElement('a');
            content.href = url;
            content.download = file.originalName;
            content.textContent = 'Download ' + file.originalName;
          }

          const info = document.createElement('p');
          info.innerHTML = `
            <strong>${file.originalName}</strong><br>
            Size: ${file.fileSize} bytes<br>
            User: ${file.user?.firstName || ''} ${file.user?.lastName || ''}<br>
            Task: ${file.task?.title || 'N/A'} (${file.task?.points || 0} pts)
          `;

          // ✅ Accept button
          const acceptBtn = document.createElement('button');
          acceptBtn.className = 'accept-btn';
          acceptBtn.textContent = 'Accept';
          acceptBtn.onclick = async () => {
            const res = await fetch(
              `http://localhost:3009/files/${file.id}/accept`,
              { method: 'PATCH' },
            );
            const result = await res.json();
            alert(result.message || 'File accepted');
            fetchFiles(); // refresh list
          };

          // ❌ Refuse button
          const refuseBtn = document.createElement('button');
          refuseBtn.className = 'refuse-btn';
          refuseBtn.textContent = 'Refuse';
          refuseBtn.onclick = async () => {
            const res = await fetch(
              `http://localhost:3009/files/${file.id}/refuse`,
              { method: 'DELETE' },
            );
            const result = await res.json();
            alert(result.message || 'File refused');
            fetchFiles(); // refresh list
          };

          card.appendChild(content);
          card.appendChild(info);
          card.appendChild(acceptBtn);
          card.appendChild(refuseBtn);
          gallery.appendChild(card);
        });
      }

      fetchFiles();
    </script>
  </body>
</html>
